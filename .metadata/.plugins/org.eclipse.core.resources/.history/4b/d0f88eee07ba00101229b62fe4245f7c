#include "adc.h"
#include "stm32l4xx_hal.h"

static ADC_HandleTypeDef* h_adc;

const uint8_t ADC_BITS = 12;
const float MAX_VOLTS = 3.3;
const uint16_t MAX_ADC_VAL = (1 << ADC_BITS) - 1;

void adc_init(ADC_HandleTypeDef* adc) {
	h_adc = adc;

	HAL_ADCEx_Calibration_Start(h_adc, ADC_SINGLE_ENDED);

}

uint32_t adc_read_channel_blocking(uint32_t channel)
{
	ADC_ChannelConfTypeDef sConfig = {0};
	sConfig.Channel = channel;
	sConfig.Rank = ADC_REGULAR_RANK_1;
	sConfig.SamplingTime = ADC_SAMPLETIME_640CYCLES_5;
	sConfig.SingleDiff = ADC_SINGLE_ENDED;
	sConfig.OffsetNumber = ADC_OFFSET_NONE;
	sConfig.Offset = 0;
	if (HAL_ADC_ConfigChannel(h_adc, &sConfig) != HAL_OK)
	{
		Error_Handler();
	}
	HAL_ADC_Start(h_adc);
	if (HAL_ADC_PollForConversion(h_adc, HAL_MAX_DELAY) != HAL_OK)
	{
		Error_Handler();
	}
	uint32_t raw = HAL_ADC_GetValue(h_adc);
	HAL_ADC_Stop(h_adc);
	return raw;
}


